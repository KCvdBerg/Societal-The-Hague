# README
This GitHub contains two folders and three separate files. The first folder ‘Interviews’, contains a summary of the interviews conducted during the span of this project. The ‘output’ folder contains the outputs generated by the model, which is the ‘Impact Network Analysis Tool – Municipality of the Hague.ipynb’ file. The 3D visualisation of the results can be found in the ‘Impact Network Analysis Tool – QGIS.qgz’ file. The last file contains an annotated PowerPoint presentation, in which the context of this project is described, as well as the results, limitations and recommendations. 

# Python notebook 
The model can be found in the ‘Impact Network Analysis Tool – Municipality of the Hague.ipynb’ file. This file contains the steps to collecting the network data, creating the network, running the model and gathering its results. It is important to node that this proof of concept makes use of Open Street Map to collect road data, and generates random start and end points for the cars in the network. The amount of cars in the model, as well as the delay they experience because of other cars in the network, are arbitrarily chosen. This because at the time of developing this tool, this data was not available to the programmers. However, the municipality can easily import this data to the file, and run the results with actual real life datapoints.
The file starts with collecting street data in a range of 2 km around the World Forum – where the NATO summit is held. What follows is a bunch of data cleaning. When integrating this tool with the digital twin city, this won’t be necessary anymore. From this data, a network graph is constructed, using the NetworkX packages Python offers. 
For this proof of concept, 100 cars are generated with a random beginning and end point. They calculate the fastest route to take based on the time it would take to travel there, as well as the delay caused by other cars in the network. This delay is set to 3 minutes if there is already a car on the node (intersection) it needs to pass, and 5 minutes if there is already a car on the edge (street) its needs to use. These delays can be changed in the move_cars_over_time function. The cars (dataframe) as well as the maximum amount of timesteps (the time the model should run) are an input of this function. 
The model is run with two scenario’s – the base case (which represent the normal traffic flow) and the closed case (in which the Johan de Wittlaan and the Eisenhowerlaan are closed, to represent the months leading up to the NATO summit). The results are written to an Excel file, as well as plot on a density map. This density map is also saved as a shape file, to be used in QGIS.

# QGIS
For the 3D visualisation, the open source geographical information system programme QGIS is used. The minimum version that can be used is 3.34, however for this project, version 3.40.2 – Bratislava is used. 

## Load in the dataset
Load in the dataset made in the Python Notebook as a vector layer. Use the heatmap_GDF_final.shp file. The projection should automatically be correct. If not – change it to EPSG: 28992 – Amersfoort/ RD New. Go to its properties – symbology, and select categorical at the top. In the value field, type Normalized, the corresponding column will be selected. For colour gradient, select a random one and press ‘Classify’ at the bottom. Quite some edges do not have any visitations, so adapt the colour gradient to reflect that. Press on the field and add/ remove colour gradient stops so that five are left. Change the positions and colours to the ones below and press OK
1)	Position – 0% | #EFEFEF
2)	Position – 3% | #6CDFE6
3)	Position – 36% | #91A0DE
4)	Position – 69% | #BE4CD1
5)	Position – 100% | #E413B2
The exact positions might have to be adapted based on the dataset/ run used. Ensure that the classified range that is fully zero (top one), is the only grey one, and the rest is divided over the other four colours. Press the symbol field. Adapt the width of the line by going into field type and selecting the width column from the data frame. Press OK twice. The 2D layer is now done. 
For the 3D layer, go into properties again and select 3D view. Add a rule-based symbol and add five rules. For rule 1, set the width, shift and extrusion to 1, and the colour of both the spread and border to the grey colour used earlier (#EFEFEF). The exact values for rules 2-5 depend on which run is used – dived them in such a way that each colour gets assigned about a quarter of the values. This can be checked by pressing the ‘Test’ button next to the expression filter. For these rules, set the width to 4, shift to 1 and extrusion to 2.
1)	“Width” = 0
2)	“Normalized” > 0 and “Normalized” < 0.06
3)	“Normalized” > 0.06 and “Normalized” <0.11
4)	“Normalized” > 0.11 and “Normalized” < 0.21
5)	“Normalized” > 0.21

## Lock zoom
As the 3D tiles are large files, lock the zoom as to so only load the 3D tiles necessary for the project. Zoom/ drag the heatmap to the desired size. Go to project – properties – display settings, and check the ‘set full scope project’ option, followed by range map window. 


## Add 3D tiles
Start by making a free Cesium Ion account on the website, and keep your browser logged in. Go back to QGIS and install and configure the Cesium Ion plugin. The Cesium Ion icon should appear in the browser menu on the left. When you click it, the browser will open – give permission to use Cesium Ion in QGIS. Fold open the Cesium Ion menu in QGIS, and press the Google Photorealistic 3D Tiles. Use an existing token, which is set to default. Press OK, and based on the internet speed, the layer will be added. Drag the 3D layer below the heatmap on the layers menu on the bottom left. 
## 3D view
[Disclaimer: the 3D view needs a lot of graphical power on the computer. If the graphical card is not strong enough, this view might no load.] 
Go to view – 3D view – add new 3D view. A new window will open with the new 3D view. Chances are, that the heatmap will disappear. This has to do with the Z values of the layers (height) menu in the properties of each layer). This takes some trial and error to get right. For the file on the github, the following settings worked;
1)	Heatmap; change height from attached to terrain to absolute, and up the hight basis to 35
2)	3D tiles; change shift to -50
Zoom in using the mouse wheel, and get the 3D view by holding down the shift key, and dragging down on the screen. 

# Contributes
Koen van den Berg
Maryvonne Marang
Lotte Westrik Broeksma 
